#include <vector>
#include <iostream>
#include "../tensor_utils.hpp"

void lenet_model() {
  // Set up input tensor
  int t1_chans = 1;
  int t1_rows = 28;
  int t1_cols = 28;
  Tensor3D t1(t1_chans, Tensor2D(t1_rows, Tensor1D(t1_cols, 0)));
  t1 = {
    {
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   8,  38, 137, 146, 232, 254, 255, 255, 197, 109,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,  87, 107, 253, 253, 253, 253, 253, 253, 253, 253, 188,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0, 120, 237, 253, 253, 253, 248, 209, 139, 139, 230, 253, 188,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0, 112, 229, 210, 128,  96,   0,   0,   0,   0, 117, 253, 188,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0, 28,   0,   0,   0,   0,   0,   0,   45, 241, 245,  82,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  60, 253, 125,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  32, 134, 148,  98, 127,   4,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   7, 201, 253, 200,  59,  12,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 122, 246, 253, 223,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 233, 253, 253, 236,  55,  11,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 233, 253, 253, 253, 253, 210,  48,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  68, 193, 185, 243, 253, 253, 173,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  59, 253, 253, 226,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  22, 253, 253, 226,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  10,  93, 253, 253, 123,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  14, 180, 253, 253, 228,  42,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  95, 181, 253, 253, 253,  66,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   6,  33,  33, 100, 178, 253, 253, 253, 241,  88,   1,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,  32, 236, 253, 253, 253, 253, 253, 228, 122,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0, 143, 253, 253, 253, 154,  76,  24,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0},
      {  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0}
    }
  };
  for (int i = 0; i < t1_rows; i++) {
    for (int j = 0; j < t1_cols; j++) {
      t1[0][i][j] = t1[0][i][j] / 255; // Normalize values between 0 and 1
    }
  }

  // Set up 6 filters of size 5x5x1 (for the first convolution)
  int n_f1 = 6;
  int f1_chans = 1;
  int f1_rows = 5;
  int f1_cols = 5;
  std::vector<Tensor3D> f1(n_f1, Tensor3D(f1_chans, Tensor2D(f1_rows, Tensor1D(f1_cols, 0))));
  f1 = {
    {
      {
        { 0.1, -0.2,  0.1,  0.2,  0.1},
        { 0.0, -0.1,  0.1,  0.0,  0.2},
        {-0.1,  0.2,  0.3, -0.2, -0.1},
        { 0.0,  0.1,  0.0,  0.2,  0.0},
        {-0.2, -0.1,  0.1,  0.2, -0.1}
      }
    },
    {
      {
        { 0.0,  0.2,  0.1, -0.1, -0.2},
        { 0.1, -0.1, -0.2,  0.1,  0.2},
        {-0.1,  0.0,  0.1, -0.1,  0.0},
        { 0.2,  0.1, -0.1, -0.2,  0.1},
        { 0.1, -0.2,  0.0,  0.1,  0.1}
      }
    },
    {
      {
        { 0.2,  0.1, -0.1, -0.2,  0.0},
        {-0.1,  0.2,  0.1, -0.1,  0.0},
        { 0.0, -0.2,  0.2,  0.1, -0.1},
        {-0.1,  0.1, -0.2,  0.2,  0.1},
        { 0.1, -0.1,  0.0, -0.2,  0.1}
      }
    },
    {
      {
        { 0.1, -0.1,  0.2, -0.1,  0.1},
        {-0.2,  0.0,  0.1,  0.2, -0.1},
        { 0.1, -0.2,  0.0,  0.1, -0.1},
        { 0.0,  0.1, -0.1,  0.2,  0.1},
        {-0.1, -0.2,  0.1, -0.1,  0.2}
      }
    },
    {
      {
        {-0.1,  0.2,  0.1, -0.1,  0.0},
        { 0.1, -0.2,  0.2, -0.1,  0.1},
        {-0.2,  0.1,  0.0,  0.1, -0.2},
        { 0.2, -0.1, -0.2,  0.0,  0.1},
        {-0.1,  0.2, -0.1,  0.1,  0.0}
      }
    },
    {
      {
        { 0.0, -0.1,  0.1,  0.2,  0.1},
        { 0.2, -0.1, -0.2,  0.1,  0.0},
        {-0.1,  0.2,  0.0, -0.1,  0.1},
        { 0.1, -0.2,  0.2, -0.1,  0.2},
        { 0.0,  0.1, -0.1,  0.1, -0.2}
      }
    }
  };

  // Set up 16 filters of size 5x5x1 (for the second convolution)
  int n_f2 = 16;
  int f2_chans = 1;
  int f2_rows = 5;
  int f2_cols = 5;
  std::vector<Tensor3D> f2(n_f2, Tensor3D(f2_chans, Tensor2D(f2_rows, Tensor1D(f2_cols, 0))));
  f2 = {
    {
      {
        { 0.10, -0.20,  0.15, -0.05,  0.10},
        {-0.15,  0.25, -0.10,  0.05,  0.20},
        { 0.05, -0.10,  0.20, -0.15,  0.10},
        {-0.10,  0.20, -0.05,  0.15, -0.10},
        { 0.15, -0.20,  0.10, -0.05,  0.20}
      }
    },
    {
      {
        {-0.10,  0.15, -0.05,  0.10, -0.20},
        { 0.20, -0.15,  0.10, -0.05,  0.25},
        {-0.05,  0.10, -0.15,  0.20, -0.10},
        { 0.10, -0.20,  0.25, -0.15,  0.05},
        {-0.20,  0.05, -0.10,  0.15, -0.25}
      }
    },
    {
      {
        { 0.05, -0.10,  0.15, -0.20,  0.25},
        {-0.20,  0.15, -0.10,  0.05, -0.15},
        { 0.25, -0.05,  0.20, -0.10,  0.15},
        {-0.10,  0.25, -0.20,  0.15, -0.05},
        { 0.15, -0.10,  0.25, -0.20,  0.10}
      }
    },
    {
      {
        { 0.20, -0.05,  0.10, -0.15,  0.05},
        {-0.15,  0.25, -0.20,  0.10, -0.05},
        { 0.05, -0.10,  0.20, -0.25,  0.15},
        {-0.10,  0.05, -0.15,  0.20, -0.10},
        { 0.25, -0.20,  0.05, -0.10,  0.15}
      }
    },
    {
      {
        {-0.05,  0.10, -0.15,  0.20, -0.10},
        { 0.15, -0.20,  0.05, -0.10,  0.25},
        {-0.10,  0.15, -0.20,  0.05, -0.25},
        { 0.20, -0.05,  0.10, -0.15,  0.10},
        {-0.25,  0.20, -0.05,  0.15, -0.10}
      }
    },
    {
      {
        { 0.25, -0.10,  0.05, -0.15,  0.10},
        {-0.10,  0.20, -0.05,  0.15, -0.20},
        { 0.15, -0.25,  0.10, -0.05,  0.20},
        {-0.05,  0.15, -0.10,  0.25, -0.15},
        { 0.10, -0.20,  0.05, -0.10,  0.25}
      }
    },
    {
      {
        {-0.20,  0.25, -0.15,  0.05, -0.10},
        { 0.10, -0.05,  0.20, -0.25,  0.15},
        {-0.15,  0.10, -0.05,  0.20, -0.25},
        { 0.05, -0.20,  0.15, -0.10,  0.25},
        {-0.10,  0.15, -0.25,  0.05, -0.20}
      }
    },
    {
      {
        { 0.10, -0.20,  0.15, -0.05,  0.20},
        {-0.25,  0.10, -0.05,  0.15, -0.20},
        { 0.20, -0.25,  0.10, -0.15,  0.05},
        {-0.10,  0.20, -0.25,  0.05, -0.10},
        { 0.15, -0.05,  0.20, -0.10,  0.25}
      }
    },
    {
      {
        {-0.10,  0.25, -0.15,  0.10, -0.20},
        { 0.05, -0.10,  0.20, -0.15,  0.25},
        {-0.20,  0.05, -0.10,  0.25, -0.15},
        { 0.10, -0.25,  0.15, -0.20,  0.05},
        {-0.15,  0.10, -0.20,  0.05,  0.25}
      }
    },
    {
      {
        { 0.20, -0.10,  0.05, -0.15,  0.10},
        {-0.05,  0.15, -0.20,  0.25, -0.10},
        { 0.10, -0.20,  0.15, -0.05,  0.20},
        {-0.15,  0.10, -0.05,  0.25, -0.20},
        { 0.25, -0.15,  0.10, -0.20,  0.05}
      }
    },
    {
      {
        {-0.25,  0.10, -0.05,  0.20, -0.15},
        { 0.05, -0.20,  0.15, -0.10,  0.25},
        {-0.15,  0.25, -0.10,  0.05, -0.20},
        { 0.20, -0.10,  0.25, -0.05,  0.10},
        {-0.10,  0.20, -0.25,  0.15, -0.05}
      }
    },
    {
      {
        { 0.05, -0.15,  0.10, -0.20,  0.15},
        {-0.10,  0.25, -0.20,  0.05, -0.10},
        { 0.15, -0.10,  0.05, -0.20,  0.25},
        {-0.20,  0.15, -0.25,  0.10, -0.05},
        { 0.10, -0.20,  0.15, -0.10,  0.05}
      }
    },
    {
      {
        {-0.05,  0.10, -0.15,  0.25, -0.20},
        { 0.15, -0.20,  0.05, -0.10,  0.20},
        {-0.10,  0.25, -0.05,  0.15, -0.25},
        { 0.20, -0.10,  0.15, -0.20,  0.10},
        {-0.15,  0.05, -0.20,  0.10,  0.25}
      }
    },
    {
      {
        { 0.25, -0.20,  0.10, -0.15,  0.05},
        {-0.15,  0.10, -0.05,  0.20, -0.25},
        { 0.10, -0.25,  0.15, -0.20,  0.05},
        {-0.20,  0.05, -0.15,  0.10, -0.25},
        { 0.15, -0.10,  0.20, -0.05,  0.10}
      }
    },
    {
      {
        {-0.10,  0.05, -0.20,  0.15, -0.25},
        { 0.20, -0.15,  0.10, -0.05,  0.25},
        {-0.05,  0.10, -0.20,  0.25, -0.15},
        { 0.15, -0.20,  0.05, -0.10,  0.20},
        {-0.25,  0.15, -0.05,  0.10, -0.20}
      }
    },
    {
      {
        { 0.15, -0.10,  0.20, -0.05,  0.10},
        {-0.25,  0.05, -0.15,  0.20, -0.10},
        { 0.10, -0.20,  0.05, -0.15,  0.25},
        {-0.05,  0.15, -0.10,  0.25, -0.20},
        { 0.20, -0.25,  0.10, -0.05,  0.15}
      }
    }
  };

  // Set up fully connected layers output shapes
  int fc_0 = 256;
  int fc_1 = 120;
  int fc_2 = 84;
  int fc_3 = 10;

  // Set up fully connected layers filters
  Tensor2D f_fc1(fc_1, Tensor1D(fc_0, 1));
  Tensor2D f_fc2(fc_2, Tensor1D(fc_1, 1));
  Tensor2D f_fc3(fc_3, Tensor1D(fc_2, 1));

  // Set up fully connected layers biases
  Tensor1D b_fc1(fc_1, 0);
  Tensor1D b_fc2(fc_2, 0);
  Tensor1D b_fc3(fc_3, 0);

  std::cout << "------------------------------------------------------------" << std::endl;

  // Conv2D
  std::cout << "Layer 1: Conv2D" << std::endl;
  std::cout << "Input tensor: " << t1[0].size() << "x" << t1[0][0].size() << "x" << t1.size() << std::endl;
  tensor_print_3d(t1);
  std::cout << "Kernel filters (" << f1.size() << "): " << f1[0][0].size() << "x" << f1[0][0][0].size() << "x" << f1[0].size() << std::endl;
  for (int i = 0; i < n_f1; i++) {
    std::cout << "Filter " << i + 1 << ":" << std::endl;
    tensor_print_3d(f1[i]);
  }
  std::cout << "Processing Conv2D..." << std::endl;
  Tensor3D t2 = tensor_conv_3d(t1, f1, ACTIVATION_FUNCTION_RELU);
  std::cout << "Output tensor: " << t2[0].size() << "x" << t2[0][0].size() << "x" << t2.size() << std::endl;
  tensor_print_3d(t2);

  std::cout << "------------------------------------------------------------" << std::endl;
  
  // AveragePooling2D
  std::cout << "Layer 2: AveragePooling2D" << std::endl;
  std::cout << "Input tensor: " << t2[0].size() << "x" << t2[0][0].size() << "x" << t2.size() << std::endl;
  tensor_print_3d(t2);
  std::cout << "Processing AveragePooling2D..." << std::endl;
  Tensor3D t3 = tensor_avg_pooling_3d(t2);
  std::cout << "Output tensor: " << t3[0].size() << "x" << t3[0][0].size() << "x" << t3.size() << std::endl;
  tensor_print_3d(t3);

  std::cout << "------------------------------------------------------------" << std::endl;

  // Conv2D
  std::cout << "Layer 3: Conv2D" << std::endl;
  std::cout << "Input tensor: " << t3[0].size() << "x" << t3[0][0].size() << "x" << t3.size() << std::endl;
  tensor_print_3d(t3);
  std::cout << "Kernel filters (" << f2.size() << "): " << f2[0][0].size() << "x" << f2[0][0][0].size() << "x" << f2[0].size() << std::endl;
  for (int i = 0; i < n_f2; i++) {
    std::cout << "Filter " << i + 1 << ":" << std::endl;
    tensor_print_3d(f2[i]);
  }
  std::cout << "Processing Conv2D..." << std::endl;
  Tensor3D t4 = tensor_conv_3d(t3, f2, ACTIVATION_FUNCTION_RELU);
  std::cout << "Output tensor: " << t4[0].size() << "x" << t4[0][0].size() << "x" << t4.size() << std::endl;
  tensor_print_3d(t4);
  
  std::cout << "------------------------------------------------------------" << std::endl;

  // AveragePooling2D
  std::cout << "Layer 4: AveragePooling2D" << std::endl;
  std::cout << "Input tensor: " << t4[0].size() << "x" << t4[0][0].size() << "x" << t4.size() << std::endl;
  tensor_print_3d(t4);
  std::cout << "Processing AveragePooling2D..." << std::endl;
  Tensor3D t5 = tensor_avg_pooling_3d(t4);
  std::cout << "Output tensor: " << t5[0].size() << "x" << t5[0][0].size() << "x" << t5.size() << std::endl;
  tensor_print_3d(t5);

  std::cout << "------------------------------------------------------------" << std::endl;

  // Flatten
  std::cout << "Layer 5: Flatten" << std::endl;
  std::cout << "Input tensor: " << t5[0].size() << "x" << t5[0][0].size() << "x" << t5.size() << std::endl;
  tensor_print_3d(t5);
  std::cout << "Processing Flatten..." << std::endl;
  Tensor1D t6 = tensor_flatten_3d(t5);
  std::cout << "Output tensor: " << t6.size() << std::endl;
  tensor_print_1d(t6);

  std::cout << "------------------------------------------------------------" << std::endl;

  // Dense
  std::cout << "Layer 6: Dense" << std::endl;
  std::cout << "Input tensor: " << t6.size() << std::endl;
  tensor_print_1d(t6);
  std::cout << "Processing Dense..." << std::endl;
  Tensor1D t7 = tensor_dense_1d(t6, f_fc1, b_fc1, ACTIVATION_FUNCTION_RELU);
  std::cout << "Output tensor: " << t7.size() << std::endl;
  tensor_print_1d(t7);

  std::cout << "------------------------------------------------------------" << std::endl;

  // Dense
  std::cout << "Layer 7: Dense" << std::endl;
  std::cout << "Input tensor: " << t7.size() << std::endl;
  tensor_print_1d(t7);
  std::cout << "Processing Dense..." << std::endl;
  Tensor1D t8 = tensor_dense_1d(t7, f_fc2, b_fc2, ACTIVATION_FUNCTION_RELU);
  std::cout << "Output tensor: " << t8.size() << std::endl;
  tensor_print_1d(t8);

  std::cout << "------------------------------------------------------------" << std::endl;

  // Dense
  std::cout << "Layer 8: Dense" << std::endl;
  std::cout << "Input tensor: " << t8.size() << std::endl;
  tensor_print_1d(t8);
  std::cout << "Processing Dense..." << std::endl;
  Tensor1D t9 = tensor_dense_1d(t8, f_fc3, b_fc3, ACTIVATION_FUNCTION_SOFTMAX);
  std::cout << "Output tensor: " << t9.size() << std::endl;
  tensor_print_1d(t9);
}
